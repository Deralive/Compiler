<!DOCTYPE html>
<html lang="zh-CN">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>C++ Compiler Labs</title>

        <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/viz.js/2.1.2/viz.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/viz.js/2.1.2/full.render.js"></script>

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/clike/clike.min.js"></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/closebrackets.min.js"></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/matchbrackets.min.js"></script>

        <style>
            body {
                margin: 0;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                display: flex;
                height: 100vh;
                background-color: #f4f4f9;
            }

            .sidebar {
                width: 260px;
                background-color: #2c3e50;
                color: white;
                display: flex;
                flex-direction: column;
                padding: 20px;
                box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
                overflow-y: auto;
                flex-shrink: 0;
            }

            .sidebar h2 {
                margin-bottom: 20px;
                text-align: center;
                font-size: 1.4rem;
                border-bottom: 1px solid #34495e;
                padding-bottom: 10px;
            }

            .lab-btn {
                background-color: #34495e;
                color: #bdc3c7;
                border: none;
                padding: 12px 15px;
                margin-bottom: 8px;
                text-align: left;
                cursor: pointer;
                border-radius: 6px;
                transition: all 0.2s;
                font-size: 0.95rem;
            }

            .lab-btn:hover {
                background-color: #3e5871;
                color: white;
            }

            .lab-btn.active {
                background-color: #3498db;
                color: white;
                font-weight: 600;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            }

            .lab-btn.highlight {
                border-left: 4px solid #f1c40f;
                color: #f1c40f;
            }

            .lab-btn.highlight.active {
                background-color: #f1c40f;
                color: #2c3e50;
            }

            .main-content {
                flex: 1;
                padding: 30px 40px;
                display: flex;
                flex-direction: column;
                overflow-y: auto;
                height: 100vh;
                box-sizing: border-box;
            }

            .container {
                background: white;
                padding: 30px;
                border-radius: 12px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
                width: 100%;
                box-sizing: border-box;
                display: flex;
                flex-direction: column;
                min-height: 100%;
            }

            #lab-title {
                color: #2c3e50;
                margin-top: 0;
                margin-bottom: 20px;
                font-size: 2rem;
                font-weight: 700;
                text-align: center;
                border-bottom: 3px solid #3498db;
                padding-bottom: 15px;
            }

            .test-case-area {
                margin-bottom: 15px;
                padding: 10px;
                background-color: #f8f9fa;
                border-radius: 8px;
                border: 1px dashed #ced4da;
            }

            .test-case-label {
                font-size: 0.9rem;
                font-weight: bold;
                color: #555;
                margin-bottom: 5px;
                display: block;
            }

            .test-buttons-grid {
                display: grid;
                grid-template-columns: repeat(5, 1fr);
                gap: 8px;
            }

            .test-btn {
                background-color: #fff;
                border: 1px solid #3498db;
                color: #3498db;
                padding: 6px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 0.85rem;
                transition: all 0.2s;
                text-align: center;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .test-btn:hover {
                background-color: #3498db;
                color: white;
            }

            #input-text {
                display: none;
            }

            .CodeMirror {
                height: 140px;
                border-radius: 6px;
                font-family: 'Consolas', 'Fira Code', monospace;
                font-size: 14px;
                border: 1px solid #ddd;
                flex: 1;
            }

            textarea.simple-input {
                width: 100%;
                height: 100px;
                padding: 10px;
                border: 1px solid #bdc3c7;
                border-radius: 6px;
                font-family: 'Consolas', monospace;
                font-size: 0.9rem;
                box-sizing: border-box;
                resize: vertical;
                background-color: #fafafa;
                outline: none;
            }

            textarea.simple-input:focus {
                border-color: #3498db;
            }

            .controls {
                margin: 10px 0;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .status {
                font-size: 0.9rem;
                color: #7f8c8d;
            }

            button.run-btn {
                background-color: #27ae60;
                color: white;
                border: none;
                padding: 10px 30px;
                font-size: 1rem;
                font-weight: bold;
                border-radius: 6px;
                cursor: pointer;
                transition: background-color 0.2s;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            }

            button.run-btn:hover {
                background-color: #219150;
                transform: translateY(-1px);
            }

            .output-wrapper {
                display: flex;
                flex-direction: column;
                border: 1px solid #ddd;
                border-radius: 6px;
                background: #2c3e50;
                overflow: hidden;
                margin-bottom: 20px;
                transition: height 0.3s;
            }

            .panel-header {
                background: #34495e;
                color: #ecf0f1;
                padding: 8px 15px;
                font-size: 0.9rem;
                font-weight: bold;
                border-bottom: 1px solid #2c3e50;
                display: flex;
                justify-content: space-between;
            }

            .output-area {
                padding: 15px;
                color: #ecf0f1;
                font-family: 'Consolas', 'Monaco', monospace;
                white-space: pre-wrap;
                overflow-y: auto;
                font-size: 0.9rem;
                margin: 0;
                width: 100%;
                box-sizing: border-box;
                height: 100%;
            }

            .visual-container {
                display: none;
                flex-direction: column;
                border: 1px solid #ddd;
                border-radius: 6px;
                background: white;
                overflow: hidden;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
                height: 500px;
                min-height: 400px;
                width: 100%;
                box-sizing: border-box;
            }

            #tree-chart-view,
            #dfa-chart-view {
                flex: 1;
                width: 100%;
                height: 100%;
                overflow: hidden;
            }

            #dfa-chart-view {
                display: flex;
                justify-content: center;
                align-items: center;
                overflow: auto;
            }

            .empty-tip {
                text-align: center;
                color: #999;
                margin-top: 150px;
            }

            .grammar-layout {
                display: flex;
                gap: 20px;
                height: 500px;
            }

            .grammar-input-box {
                flex: 1;
                display: flex;
                flex-direction: column;
            }

            .grammar-output-box {
                flex: 2;
                overflow: auto;
                border: 1px solid #eee;
                border-radius: 6px;
                padding: 10px;
                background: #fafafa;
            }

            table.slr-table {
                width: 100%;
                border-collapse: collapse;
                font-size: 0.9rem;
            }

            table.slr-table th,
            table.slr-table td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: center;
            }

            table.slr-table th {
                background-color: #34495e;
                color: white;
                position: sticky;
                top: 0;
            }

            table.slr-table tr:nth-child(even) {
                background-color: #f9f9f9;
            }

            .cell-shift {
                background-color: #d1ecf1;
                color: #0c5460;
                font-weight: bold;
            }

            .cell-reduce {
                background-color: #d4edda;
                color: #155724;
                font-weight: bold;
            }

            .cell-accept {
                background-color: #fff3cd;
                color: #856404;
                font-weight: bold;
            }

            .cell-goto {
                background-color: #e2e3e5;
                color: #383d41;
            }

            .sets-container {
                display: flex;
                gap: 15px;
                height: 100%;
            }

            .set-panel {
                flex: 1;
                display: flex;
                flex-direction: column;
            }

            .set-panel h3 {
                margin: 0 0 10px 0;
                text-align: center;
                color: #2c3e50;
                border-bottom: 2px solid #3498db;
                padding-bottom: 5px;
            }

            .set-content {
                flex: 1;
                overflow-y: auto;
                border: 1px solid #ddd;
                border-radius: 4px;
                background: white;
            }

            .set-item {
                display: flex;
                border-bottom: 1px solid #eee;
                padding: 8px;
            }

            .set-item:last-child {
                border-bottom: none;
            }

            .set-key {
                font-weight: bold;
                width: 60px;
                color: #e74c3c;
                border-right: 1px solid #eee;
                margin-right: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .set-val {
                flex: 1;
                font-family: monospace;
                color: #2980b9;
                word-break: break-all;
            }
        </style>
    </head>

    <body>
        <div class="sidebar">
            <h2>ç¼–è¯‘åŸç†å®éªŒ</h2>
            <button class="lab-btn active" onclick="selectLab(1)">Lab 1: è¯æ³•åˆ†æ</button>
            <button class="lab-btn" onclick="selectLab(2)">Lab 2: LL è¯­æ³•åˆ†æ</button>
            <button class="lab-btn" onclick="selectLab(3)">Lab 3: LR è¯­æ³•åˆ†æ</button>
            <button class="lab-btn" onclick="selectLab(4)">Lab 4: è¯­ä¹‰åˆ†æ</button>
            <div style="height: 10px;"></div>
            <button class="lab-btn highlight" onclick="selectLab(5)">â˜… SLR(1) è¡¨ç”Ÿæˆå™¨</button>
            <button class="lab-btn highlight" onclick="selectLab(6)">â˜… FIRST/FOLLOW é›†</button>
        </div>

        <div class="main-content">
            <div class="container">
                <h1 id="lab-title">Lab 1: è¯æ³•åˆ†æ</h1>

                <div id="standard-lab-area" style="display: flex; flex-direction: column; flex: 1;">

                    <div class="test-case-area">
                        <span class="test-case-label">é¢„è®¾æµ‹è¯•é›† (ç‚¹å‡»è‡ªåŠ¨å¡«å……)ï¼š</span>
                        <div class="test-buttons-grid" id="test-grid"></div>
                    </div>

                    <div style="display: flex; gap: 10px; align-items: stretch; margin-bottom: 5px;">
                        <textarea id="input-text" placeholder="åœ¨æ­¤è¾“å…¥ C ä»£ç ..."></textarea>
                        <button class="run-btn" style="height: 140px; white-space: nowrap;"
                            onclick="runAnalysis()">è¿è¡Œ<br>Compile</button>
                    </div>

                    <div id="regex-control-panel"
                        style="display: none; background: #fff8e1; border: 1px solid #ffeeba; padding: 10px; margin-bottom: 10px; border-radius: 6px;">
                        <span style="font-weight: bold; color: #856404;">â˜… Lab 1 äº®ç‚¹: æ­£åˆ™è¡¨è¾¾å¼å¯è§†åŒ– (NFA)</span>
                        <div style="display: flex; gap: 10px; margin-top: 5px;">
                            <input type="text" id="regex-input" value="a(a|b)*b"
                                style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-family: monospace;">
                            <button onclick="drawRegex()"
                                style="background: #f1c40f; color: #333; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold;">ç”Ÿæˆ
                                NFA</button>
                        </div>
                    </div>

                    <div class="controls">
                        <span class="status" id="wasm-status">æ­£åœ¨åŠ è½½ç¼–è¯‘å™¨æ ¸å¿ƒ...</span>
                    </div>

                    <div class="output-wrapper" id="console-wrapper">
                        <div class="panel-header">
                            <span>ğŸ“œ æ§åˆ¶å°è¾“å‡º (Console Output)</span>
                        </div>
                        <div id="output-text" class="output-area">ç­‰å¾…è¿è¡Œ...</div>
                    </div>

                    <div id="tree-visual-area" class="visual-container">
                        <div class="panel-header"
                            style="background: #f1f8ff; color: #333; border-bottom: 1px solid #ddd;">
                            <span>ğŸŒ³ è¯­æ³•æ ‘å¯è§†åŒ– (Parse Tree)</span>
                            <span style="font-size:0.8rem; color:#666;">æ»šè½®ç¼©æ”¾ / æ‹–æ‹½ç§»åŠ¨</span>
                        </div>
                        <div id="tree-chart-view">
                            <div class="empty-tip">ç‚¹å‡»è¿è¡ŒæŸ¥çœ‹è¯­æ³•æ ‘</div>
                        </div>
                    </div>

                    <div id="dfa-visual-area" class="visual-container">
                        <div class="panel-header"
                            style="background: #f1f8ff; color: #333; border-bottom: 1px solid #ddd;">
                            <span>ğŸ•¸ï¸ NFA çŠ¶æ€æœºå¯è§†åŒ–</span>
                            <span style="font-size:0.8rem; color:#666;">Generated by Viz.js</span>
                        </div>
                        <div id="dfa-chart-view">
                            <div class="empty-tip" style="margin-top: 100px;">è¾“å…¥æ­£åˆ™è¡¨è¾¾å¼å¹¶ç‚¹å‡»ç”Ÿæˆ</div>
                        </div>
                    </div>

                </div>

                <div id="grammar-tool-area" style="display: none;">
                    <div
                        style="background: #fff8e1; border-left: 5px solid #ffc107; padding: 10px; margin-bottom: 20px; font-size: 0.9rem;">
                        <strong>âš ï¸ è¾“å…¥è§„èŒƒï¼š</strong>å•å­—ç¬¦ç»ˆç»“ç¬¦ (å¦‚ <code>i</code>), <code>@</code> ä»£è¡¨ç©ºä¸², ç¬¦å·é—´åŠ ç©ºæ ¼ã€‚
                    </div>
                    <div class="grammar-layout">
                        <div class="grammar-input-box">
                            <textarea id="grammar-input" class="simple-input"
                                style="flex: 1; resize: none; margin-bottom: 10px;" placeholder="è¾“å…¥æ–‡æ³•..."></textarea>
                            <button class="run-btn" style="width: 100%; margin: 0;" onclick="generateTable()">âœ¨
                                ç”Ÿæˆè¡¨æ ¼</button>
                        </div>
                        <div class="grammar-output-box" id="table-container">
                            <div style="color: #999; text-align: center; margin-top: 80px;">è¯·åœ¨å·¦ä¾§è¾“å…¥æ–‡æ³•</div>
                        </div>
                    </div>
                </div>

                <div id="sets-tool-area" style="display: none;">
                    <div
                        style="background: #e8f4fd; border-left: 5px solid #3498db; padding: 10px; margin-bottom: 20px; font-size: 0.9rem;">
                        <strong>äº¤äº’å¼è®¡ç®—ï¼š</strong>è¾“å…¥æ–‡æ³•ï¼Œç«‹å³æŸ¥çœ‹æ‰€æœ‰éç»ˆç»“ç¬¦çš„é›†åˆè¯¦æƒ…ã€‚
                    </div>
                    <div class="grammar-layout">
                        <div class="grammar-input-box">
                            <textarea id="sets-input" class="simple-input"
                                style="flex: 1; resize: none; margin-bottom: 10px;" placeholder="è¾“å…¥æ–‡æ³•..."></textarea>
                            <button class="run-btn" style="width: 100%; margin: 0; background-color: #3498db;"
                                onclick="generateSets()">ğŸ” è®¡ç®—é›†åˆ</button>
                        </div>
                        <div class="grammar-output-box" style="background: #f4f6f8;">
                            <div id="sets-container" class="sets-container">
                                <div class="set-panel">
                                    <h3>FIRST é›†</h3>
                                    <div id="first-res" class="set-content">
                                        <div class="empty-tip" style="margin-top: 50px;">ç­‰å¾…è®¡ç®—...</div>
                                    </div>
                                </div>
                                <div class="set-panel">
                                    <h3>FOLLOW é›†</h3>
                                    <div id="follow-res" class="set-content">
                                        <div class="empty-tip" style="margin-top: 50px;">ç­‰å¾…è®¡ç®—...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <script>
            var currentLabId = 1;
            var wasmModule = null;
            var treeChart = null;
            var viz = new Viz();
            var codeEditor = null; // CodeMirror å®ä¾‹

            // å®Œæ•´æµ‹è¯•é›†é…ç½®
            const LAB_CONFIG = {
                1: {
                    title: "Lab 1: è¯æ³•åˆ†æ (Lexical Analysis)", tests: [
                        { name: "1. Hello World", content: `int main()\n{\n    printf("HelloWorld");\n    return 0;\n    }` },
                        { name: "2. å¾ªç¯ä¸æ³¨é‡Š", content: `int main()\n{\n    int i = 0;// æ³¨é‡Š test\n    for (i = 0; i != 10; ++i)\n    {\n        printf("%d",i);\n    }\n    return 0;\n}` },
                        { name: "3. ç´§å‡‘ä»£ç ", content: `int main(){char c = "h";/* æ³¨é‡Š 12313test */if (c=="h")printf("%c",c);else print("k");return 0;}` },
                        { name: "4. C++ å…³é”®å­—", content: `bool gofor(char& ch, string& pos, const string& prog)\n{\n    ++pos;\n    if (pos >= prog.size())\n    {\n        return false;\n    }\n    else\n    {\n        ch = prog[pos];\n        return true;\n    }\n}` },
                        { name: "5. è´ªå©ªåŒ¹é…", content: `void testOp() {\n    a += b;\n    c--;\n    d >>= 2;\n}` },
                        { name: "6. ç§‘å­¦è®¡æ•°æ³•", content: `float f = 1.23;\ndouble d = 1e-10;\ndouble e = 1.5E+2;` },
                        { name: "7. è½¬ä¹‰å­—ç¬¦", content: `char* s = "";\nchar c = '\\n';\nchar b = '\\\\';` },
                        { name: "8. æ— ç©ºæ ¼å‹åŠ›", content: `x=a+b*c;` },
                        { name: "9. å®å®šä¹‰", content: `#include <stdio.h>\nint _val = 1;` },
                        { name: "10. ç»“æ„ä½“", content: `struct Node {\n    int data[10];\n    struct Node* next;\n};` }
                    ]
                },
                2: {
                    title: "Lab 2: LL(1) è¯­æ³•åˆ†æ", tests: [
                        { name: "1. ç®€å•èµ‹å€¼", content: `{\n ID = NUM ;\n}` },
                        { name: "2. ç®—æœ¯è¿ç®—", content: `{\nID = ID + NUM ;\n}` },
                        { name: "3. While å¾ªç¯", content: `{\nwhile ( ID == NUM ) \n{ \nID = NUM ;\n}\n}` },
                        { name: "4. If-Then-Else", content: `{\nif ( ID == ID )\nthen\nID = NUM ;\nelse\nID = ID * NUM ;\n}` },
                        { name: "5. åµŒå¥— If-Else", content: `{\nif ( ID < NUM ) then\n  if ( ID == NUM ) then \n    ID = NUM ;\n  else \n    ID = ID + NUM ;\nelse\n  ID = 0 ;\n}` },
                        { name: "6. å¤æ‚è¡¨è¾¾å¼", content: `{\nID = ID + ID * NUM + ID * ( ID + NUM ) ;\n}` },
                        { name: "7. æ··åˆæ§åˆ¶", content: `{\nwhile ( ID >= NUM ) {\n  if ( ID != NUM ) then\n    ID = ID + 1 ;\n  else\n    ID = ID * 2 ;\n}\n}` },
                        { name: "8. å¤šé‡è¯­å¥å—", content: `{\nID = NUM ;\n{\n  ID = ID + 1 ;\n  {\n    ID = NUM ;\n  }\n}\n}` },
                        { name: "9. [é”™] ç¼ºåˆ†å·", content: `{\nID = NUM\nID = ID + 1 ;\n}` },
                        { name: "10. [é”™] æ‹¬å·", content: `{\nID = ( ID + NUM * ID ;\n}` }
                    ]
                },
                3: {
                    title: "Lab 3: LR(1) è¯­æ³•åˆ†æ", tests: [
                        { name: "1. ç®€å•èµ‹å€¼", content: `{\n  ID = NUM ;\n}` },
                        { name: "2. ç®—æœ¯è¿ç®—", content: `{\nID = ID + NUM ;\n}` },
                        { name: "3. Whileå¾ªç¯", content: `{\nwhile ( ID == NUM ) \n{ \nID = NUM \n}\n}` },
                        { name: "4. If-Else", content: `{\nif ( ID == ID )\nthen\nID = NUM ;\nelse\nID = ID * NUM ;\n}` },
                        { name: "5. ç©ºå—", content: `{\n}` },
                        { name: "6. è¯­å¥åºåˆ—", content: `{\nID = NUM ;\nID = ID ;\n}` },
                        { name: "7. åµŒå¥—å—", content: `{\n{\n  ID = NUM ;\n}\n}` },
                        { name: "8. ä¼˜å…ˆçº§", content: `{\nID = ID + ID * NUM ;\n}` },
                        { name: "9. æ‹¬å·", content: `{\nID = ( ID + NUM ) * NUM ;\n}` },
                        { name: "10. å¤æ‚åµŒå¥—", content: `{\nif ( ID >= NUM ) then\n  while ( ID < NUM ) ID = NUM ;\nelse\n  ID = NUM ;\n}` }
                    ]
                },
                4: {
                    title: "Lab 4: è¯­ä¹‰åˆ†æ", tests: [
                        { name: "1. åŸºç¡€è®¡ç®—", content: `int a = 1 ; int b = 2 ; real c = 3.0 ;\n{\na = a + 1 ;\nb = b * a ;\nif ( a < b ) then c = c / 2 ; else c = c / 4 ; \n}` },
                        { name: "2. é”™è¯¯æ£€æµ‹", content: `int a = 3 ; int b = 5.73 ; real c = 3.0 ;\n{\na = a + 1 ;\nb = b + a ;\nif ( a < b ) then c = c / 0 ; else c = c / 4 ; \n}` },
                        { name: "3. é€»è¾‘ ==", content: `int a = 10 ; int b = 25 ; real c = 2.1 ;\n{\na = a + 1 ;\nc = c * b ;\nb = b * a ;\nif ( a == b ) then c = c / 3 ; else c = c / 5 ; \n}` },
                        { name: "4. å¤æ‚æµ", content: `int a = 16 ; int b = 21 ; real c = 3.0 ;\n{\na = a - 1 ;\nb = b + a ;\nif ( a <= b ) then a = b / 2 ; else c = c / 4 ; \na = a * 2 - 1 ;\nif ( a >= b ) then c = c / 2 ; else c = c / 4 ; \n}` },
                        { name: "5. ä¼˜å…ˆçº§", content: `int a = 2 ; int b = 3 ; int c = 0 ; int d = 0 ;\n{\nc = a + b * 4 ;\nd = 10 - 4 / a ;\n}` },
                        { name: "6. æœªå®šä¹‰", content: `int a = 10 ;\n{\nx = a + 1 ;\n}` },
                        { name: "7. æ··åˆç±»å‹", content: `int i = 5 ; real r = 2.5 ;\n{\nr = r + i ;\n}` },
                        { name: "8. é€»è¾‘ !=", content: `int a = 5 ; int b = 10 ;\n{\nif ( a != 5 ) then b = 0 ; else b = 20 ; \n}` },
                        { name: "9. é€»è¾‘ >=", content: `int a = 10 ; int b = 10 ;\n{\nif ( a >= b ) then a = 1 ; else a = 0 ; \n}` },
                        { name: "10. ç±»å‹é”™è¯¯", content: `int a = 1 ;\n{\na = 3.5 ;\n}` }
                    ]
                }
            };

            var Module = {
                onRuntimeInitialized: function () {
                    wasmModule = Module;
                    document.getElementById('wasm-status').innerText = "ç¼–è¯‘å™¨æ ¸å¿ƒå·²å°±ç»ª";
                    document.getElementById('wasm-status').style.color = "#27ae60";
                }
            };

            function selectLab(id) {
                currentLabId = id;
                document.querySelectorAll('.lab-btn').forEach((btn, index) => {
                    if (index + 1 === id) btn.classList.add('active'); else btn.classList.remove('active');
                });

                // åŒºåŸŸ
                const stdArea = document.getElementById('standard-lab-area');
                const toolArea = document.getElementById('grammar-tool-area');
                const setsArea = document.getElementById('sets-tool-area');
                const titleElem = document.getElementById('lab-title');

                const regexPanel = document.getElementById('regex-control-panel');
                const dfaArea = document.getElementById('dfa-visual-area');
                const treeArea = document.getElementById('tree-visual-area');
                const outputWrapper = document.getElementById('console-wrapper');

                // é‡ç½®
                stdArea.style.display = 'none';
                toolArea.style.display = 'none';
                setsArea.style.display = 'none';
                regexPanel.style.display = 'none';
                dfaArea.style.display = 'none';
                treeArea.style.display = 'none';
                outputWrapper.style.height = "550px";

                if (id === 5) {
                    // Lab 5
                    titleElem.innerText = "â˜… SLR(1) åˆ†æè¡¨å¯è§†åŒ–";
                    toolArea.style.display = 'block';
                    if (!document.getElementById('grammar-input').value) document.getElementById('grammar-input').value = "S -> E\nE -> E + T\nE -> T\nT -> T * F\nT -> F\nF -> ( E )\nF -> i";
                } else if (id === 6) {
                    // Lab 6
                    titleElem.innerText = "â˜… FIRST & FOLLOW é›†è®¡ç®—å™¨";
                    setsArea.style.display = 'block';
                    // é»˜è®¤æ–‡æ³• (æ¨¡æ¿å­—ç¬¦ä¸²æ”¯æŒæ¢è¡Œ)
                    if (!document.getElementById('sets-input').value) {
                        document.getElementById('sets-input').value =
                            `E -> T E'
E' -> + T E'
E' -> @
T -> F T'
T' -> * F T'
T' -> @
F -> ( E )
F -> id`;
                    }
                } else {
                    // Lab 1-4
                    const config = LAB_CONFIG[id];
                    if (config) {
                        titleElem.innerText = config.title;
                        stdArea.style.display = 'flex';
                        renderTestButtons(config.tests);
                        // æ¸…ç©ºç¼–è¾‘å™¨
                        if (codeEditor) codeEditor.setValue("");
                        document.getElementById('output-text').innerText = "ç­‰å¾…è¿è¡Œ...";

                        if (id === 1) {
                            regexPanel.style.display = 'block';
                            dfaArea.style.display = 'flex';
                            outputWrapper.style.height = "180px";
                        } else if (id === 2) {
                            treeArea.style.display = 'flex';
                            document.getElementById('tree-chart-view').innerHTML = "<div class='empty-tip'>ç‚¹å‡»è¿è¡ŒæŸ¥çœ‹è¯­æ³•æ ‘</div>";
                            if (treeChart) { treeChart.dispose(); treeChart = null; }
                            outputWrapper.style.height = "180px";
                        }
                    }
                }
            }

            function renderTestButtons(tests) {
                const grid = document.getElementById('test-grid');
                grid.innerHTML = "";
                if (!tests) return;
                tests.forEach((test) => {
                    const btn = document.createElement('button');
                    btn.className = "test-btn";
                    btn.innerText = test.name;
                    btn.onclick = function () {
                        // ä½¿ç”¨ CodeMirror API è®¾ç½®å€¼
                        if (codeEditor) {
                            codeEditor.setValue(test.content);
                        }
                    };
                    grid.appendChild(btn);
                });
            }

            function runAnalysis() {
                if (!wasmModule || !wasmModule.processInput) return alert("æ ¸å¿ƒæœªåŠ è½½");

                // ä½¿ç”¨ CodeMirror API è·å–å€¼
                let input = "";
                if (codeEditor) {
                    input = codeEditor.getValue();
                } else {
                    input = document.getElementById('input-text').value;
                }

                if (!input.trim()) return alert("è¯·è¾“å…¥ä»£ç ");
                document.getElementById('output-text').innerText = "æ­£åœ¨åˆ†æ...";

                try {
                    let result = wasmModule.processInput(currentLabId, input);
                    document.getElementById('output-text').innerText = result.trim();

                    if (currentLabId === 2) {
                        let lines = result.split('\n');
                        let cleanLines = lines.filter(l => l.startsWith('\t') || (l.trim().length > 0 && !l.startsWith('Stack') && !l.startsWith('Match') && !l.startsWith('Action') && !l.includes('è¯­æ³•é”™è¯¯')));
                        if (cleanLines.length > 0) {
                            renderEChartsTree(parseIndentedTextToTree(cleanLines));
                        }
                    }
                } catch (e) {
                    console.error(e);
                    document.getElementById('output-text').innerText = "Error: " + e;
                }
            }

            function drawRegex() {
                const regex = document.getElementById('regex-input').value;
                if (!regex) return alert("è¯·è¾“å…¥æ­£åˆ™è¡¨è¾¾å¼");
                try {
                    const dotString = wasmModule.generateRegexGraph(regex);
                    viz.renderSVGElement(dotString)
                        .then(function (element) {
                            const container = document.getElementById('dfa-chart-view');
                            container.innerHTML = "";
                            element.style.width = "100%";
                            element.style.height = "100%";
                            container.appendChild(element);
                        })
                        .catch(error => document.getElementById('dfa-chart-view').innerHTML = "<div style='color:red'>ç”Ÿæˆå¤±è´¥</div>");
                } catch (e) { console.error(e); }
            }

            function parseIndentedTextToTree(lines) {
                let root = { name: "Root", children: [] };
                let stack = [{ node: root, depth: -1 }];
                for (let line of lines) {
                    let depth = 0;
                    while (line.startsWith('\t')) { depth++; line = line.substring(1); }
                    line = line.trim();
                    if (!line) continue;
                    let newNode = { name: line, children: [] };
                    while (stack.length > 0 && stack[stack.length - 1].depth >= depth) stack.pop();
                    let parent = stack[stack.length - 1].node;
                    parent.children.push(newNode);
                    stack.push({ node: newNode, depth: depth });
                }
                return root.children.length > 0 ? root.children[0] : null;
            }

            function renderEChartsTree(data) {
                if (treeChart) treeChart.dispose();
                treeChart = echarts.init(document.getElementById('tree-chart-view'));
                treeChart.setOption({
                    tooltip: { trigger: 'item', triggerOn: 'mousemove' },
                    series: [{
                        type: 'tree',
                        data: [data],
                        top: '5%', left: '10%', bottom: '5%', right: '20%',
                        symbolSize: 8,
                        label: { position: 'left', verticalAlign: 'middle', align: 'right', fontSize: 13 },
                        leaves: { label: { position: 'right', verticalAlign: 'middle', align: 'left' } },
                        expandAndCollapse: true,
                        initialTreeDepth: -1
                    }]
                });
                window.onresize = function () { treeChart.resize(); };
            }

            function generateTable() {
                if (!wasmModule || !wasmModule.generateGrammarTable) return alert("æ¨¡å—æœªå‡†å¤‡å¥½");
                let cleanInput = document.getElementById('grammar-input').value.replace(/\r\n/g, '\n').replace(/->/g, ' -> ').split('\n').map(l => l.trim().split(/\s+/).join(' ')).join('\n');
                try {
                    const data = JSON.parse(wasmModule.generateGrammarTable(cleanInput));
                    let html = '<table class="slr-table"><thead><tr><th>State</th>';
                    data.headers.forEach(h => html += `<th>${h}</th>`);
                    html += '</tr></thead><tbody>';
                    data.rows.forEach(row => {
                        html += `<tr><td><strong>${row.id}</strong></td>`;
                        data.headers.forEach(h => {
                            let cell = row[h] || "";
                            let cls = cell.startsWith('s') ? "cell-shift" : cell.startsWith('r') ? "cell-reduce" : cell === 'acc' ? "cell-accept" : (cell && !isNaN(cell)) ? "cell-goto" : "";
                            html += `<td class="${cls}">${cell}</td>`;
                        });
                        html += '</tr>';
                    });
                    html += '</tbody></table>';
                    document.getElementById('table-container').innerHTML = html;
                } catch (e) { document.getElementById('table-container').innerHTML = "<div style='color:red;padding:20px;'>ç”Ÿæˆå¤±è´¥</div>"; }
            }

            function generateSets() {
                if (!wasmModule || !wasmModule.generateSets) return alert("æ¨¡å—æœªå‡†å¤‡å¥½");
                let cleanInput = document.getElementById('sets-input').value.replace(/\r\n/g, '\n').replace(/->/g, ' -> ').split('\n').map(l => l.trim().split(/\s+/).join(' ')).join('\n');
                try {
                    const data = JSON.parse(wasmModule.generateSets(cleanInput));
                    const renderSet = (obj, id) => {
                        let html = "";
                        for (let key in obj) {
                            html += `<div class="set-item"><div class="set-key">${key}</div><div class="set-val">{ ${obj[key].join(', ')} }</div></div>`;
                        }
                        document.getElementById(id).innerHTML = html || "<div style='padding:10px;color:#999'>æ— æ•°æ®</div>";
                    };
                    renderSet(data.first, 'first-res');
                    renderSet(data.follow, 'follow-res');
                } catch (e) { console.error(e); alert("è®¡ç®—å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡æ³•"); }
            }

            // åˆå§‹åŒ–
            window.onload = function () {
                // åˆå§‹åŒ– CodeMirror
                codeEditor = CodeMirror.fromTextArea(document.getElementById("input-text"), {
                    mode: "text/x-c++src",
                    theme: "dracula",
                    lineNumbers: true,
                    matchBrackets: true,
                    autoCloseBrackets: true
                });
                // åˆå§‹åŒ–é»˜è®¤é€‰ä¸­ Lab 1
                selectLab(1);
            };
        </script>
        <script src="lab.js"></script>
    </body>

</html>